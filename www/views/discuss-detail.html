
<ion-view cache-view="false" class="discuss_detail">
  <ion-header-bar bindonce="chatRoom"><a href="#/app/discuss/list" class="button icon-left ion-chevron-left">&nbsp;返回</a>
    <h1 bo-text="chatRoom.name" class="title"></h1><a bo-if="chatRoom.isGroup &amp;&amp; chatRoom.easemobId!==cid" href="#/team/{{chatRoom.teamId}}" class="teams_icon icon-right">
      <svg class="svg_icon">
        <use xlink:href="#suoyouxiaodui"></use>
      </svg></a><a bo-if="chatRoom &amp;&amp; !chatRoom.isGroup" href="#/user/{{chatRoom.easemobId}}" class="teams_icon icon-right">
      <svg class="svg_icon">
        <use xlink:href="#suoyouxiaodui"></use>
      </svg></a>
  </ion-header-bar>
  <ion-content>
    <ion-refresher ng-if="moreHistory" on-refresh="readHistory()" refreshing-icon="ion-looping" pulling-text="下拉读取历史记录" refreshing-text="读取中..."></ion-refresher>
    <div ng-click="hideEmotions()" bindonce="chatsList" class="comments">
      <div class="blocks">
        <div ng-repeat="chat in chatsList track by $index" ng-init="showTime=needShowTime($index)" class="block">
          <div ng-show="showTime" class="time_block">
            <p><span ng-show="showTime===1" bo-text="chat.msgTime | date: 'yyyy'" class="time"></span></p>
            <p><span bo-text="(chat.msgTime | date: 'M月dd日 HH:mm')" class="time"></span></p>
          </div>
          <div bo-class="{'putright': chat.from === userId}" class="comment clearfix"><a ng-href="#/user/{{chat.poster._id}}" class="logo"><img ng-if="chat.poster.photo" img-cache="img-cache" ic-src="{{STATIC_URL +chat.poster.photo+ '/45/45'}}"/></a>
            <div ng-switch="chat.type" class="contents">
              <div bo-if="chat.from !== userId" ng-bind="chat.poster.nickname" class="name"></div>
              <div bo-if="chat.from === userId" class="name">我</div>
              <div ng-switch-when="IMAGE" class="content">
                <div class="triangle_isosceles triangle_img">
                  <div class="tr"><img ng-src="{{chat.body.thumbnailUrl}}" error-img="error-img" width="{{chat.body.thumbnailWidth}}" height="{{chat.body.thumbnailHeight}}" set-size="set-size"/></div>
                  <div width="{{chat.body.thumbnailWidth}}" height="{{chat.body.thumbnailHeight}}" woffset="-10" hoffset="-10" photo="chat" chat-type="chatRoom.type" target="chatRoom.easemobId" pswp-id="pswpId" photos="photos" photo-album-id="photoAlbumId" set-size="set-size" chat-photo="chat-photo" class="box"><img ng-src="{{chat.body.thumbnailUrl}}" width="{{chat.body.thumbnailWidth}}" height="{{chat.body.thumbnailHeight}}" set-size="set-size" error-img="error-img" class="img"/></div>
                </div>
              </div>
              <div ng-switch-when="VOICE" class="content">
                <button ng-click="toggleVoice(chat)" class="voice_button">{{chat.body.duration}}'<span ng-if="chat.body.isPlaying">...</span><span ng-if="!chat.body.isPlaying"></span></button>
                <div ng-if="chat.from !== userId &amp;&amp; !chat.body.isListened" class="red_spot"></div>
              </div>
              <div ng-switch-default="ng-switch-default" class="content">
                <div ng-bind-html="chat.body.text | emoji | unsafe" class="triangle_isosceles"></div>
              </div>
            </div>
          </div>
          <div ng-if="chat.status==='FAIL'" ng-cloak="ng-cloak" class="failed">
            <div class="tip"><i class="icon ion-alert-circled"></i><span>发送失败</span></div>
          </div>
          <div ng-if="chat.status==='INPROGRESS'" ng-cloak="ng-cloak" class="failed">
            <div class="tip"><i class="icon ion-looping"></i></div>
          </div>
        </div>
      </div>
    </div>
  </ion-content>
  <ion-footer-bar class="comment_box">
    <publish-box is-show-emotions="isShowEmotions" is-writing="isWriting" target="{{chatRoom.easemobId}}" content="content" publish="publish()" record-end="recordEnd()" show-upload-action-sheet="showUploadActionSheet()"></publish-box>
  </ion-footer-bar>
  <script id="confirm-upload-modal.html" type="text/ng-template">
    <ion-modal-view>
      <ion-header-bar>
        <button ng-click="cancelUpload()" class="button">取消</button>
        <h1 class="title">预览</h1>
        <button ng-click="confirmUpload()" class="button">确定</button>
      </ion-header-bar>
      <ion-content>
        <div class="card">
          <div class="item item-image"><img img-cache="img-cache" ic-src="{{previewImg}}"/></div>
        </div>
      </ion-content>
    </ion-modal-view>
  </script>
  <div tabindex="-1" role="dialog" aria-hidden="true" id="{{pswpId}}" pswp-photo-album="pswpPhotoAlbum" class="pswp">
    <div class="pswp__bg"></div>
    <div class="pswp__scroll-wrap">
      <div class="pswp__container">
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
        <div class="pswp__item"></div>
      </div>
      <div class="pswp__ui pswp__ui--hidden">
        <div class="pswp__top-bar">
          <div class="pswp__counter"></div>
          <button title="关闭" class="pswp__button pswp__button--close"></button>
          <button title="放大/缩小" class="pswp__button pswp__button--zoom"></button>
          <button ng-if="pswpPhotoAlbum" ng-click="pswpPhotoAlbum.goToAlbum()" title="查看相册" class="pswp__button dl_button_to_album"><i class="icon ion-image"></i></button>
          <div class="pswp__preloader">
            <div class="pswp__preloader__icn">
              <div class="pswp__preloader__cut">
                <div class="pswp__preloader__donut"></div>
              </div>
            </div>
          </div>
        </div>
        <button title="上一张" class="pswp__button pswp__button--arrow--left"></button>
        <button title="下一张" class="pswp__button pswp__button--arrow--right"></button>
        <div class="pswp__caption">
          <div class="pswp__caption__center"></div>
        </div>
      </div>
    </div>
  </div>
</ion-view>